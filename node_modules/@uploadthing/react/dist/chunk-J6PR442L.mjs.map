{"version":3,"sources":["../src/useUploadThing.ts","../src/utils/useEvent.ts","../src/utils/useFetch.ts"],"sourcesContent":["import { useRef, useState } from \"react\";\n\nimport type { EndpointMetadata } from \"@uploadthing/shared\";\nimport { UploadThingError } from \"@uploadthing/shared\";\nimport {\n  DANGEROUS__uploadFiles,\n  INTERNAL_DO_NOT_USE__fatalClientError,\n  resolveMaybeUrlArg,\n} from \"uploadthing/client\";\nimport type {\n  DistributiveOmit,\n  FileRouter,\n  inferEndpointInput,\n  inferErrorShape,\n} from \"uploadthing/server\";\n\nimport type { GenerateTypedHelpersOptions, UseUploadthingProps } from \"./types\";\nimport { useEvent } from \"./utils/useEvent\";\nimport useFetch from \"./utils/useFetch\";\n\ndeclare const globalThis: {\n  __UPLOADTHING?: EndpointMetadata;\n};\n\nconst useEndpointMetadata = (url: URL, endpoint: string) => {\n  const maybeServerData = globalThis.__UPLOADTHING;\n  const { data } = useFetch<EndpointMetadata>(\n    // Don't fetch if we already have the data\n    maybeServerData ? undefined : url.href,\n  );\n  return (maybeServerData ?? data)?.find((x) => x.slug === endpoint);\n};\n\nexport const INTERNAL_uploadthingHookGen = <\n  TRouter extends FileRouter,\n>(initOpts: {\n  /**\n   * URL to the UploadThing API endpoint\n   * @example URL { http://localhost:3000/api/uploadthing }\n   * @example URL { https://www.example.com/api/uploadthing }\n   */\n  url: URL;\n}) => {\n  const useUploadThing = <TEndpoint extends keyof TRouter>(\n    endpoint: TEndpoint,\n    opts?: UseUploadthingProps<TRouter, TEndpoint>,\n  ) => {\n    const [isUploading, setUploading] = useState(false);\n    const uploadProgress = useRef(0);\n    const fileProgress = useRef<Map<string, number>>(new Map());\n\n    const permittedFileInfo = useEndpointMetadata(\n      initOpts.url,\n      endpoint as string,\n    );\n\n    type InferredInput = inferEndpointInput<TRouter[typeof endpoint]>;\n    type FuncInput = undefined extends InferredInput\n      ? [files: File[], input?: undefined]\n      : [files: File[], input: InferredInput];\n\n    const startUpload = useEvent(async (...args: FuncInput) => {\n      const files = (await opts?.onBeforeUploadBegin?.(args[0])) ?? args[0];\n      const input = args[1];\n\n      setUploading(true);\n      opts?.onUploadProgress?.(0);\n      try {\n        const res = await DANGEROUS__uploadFiles<TRouter, TEndpoint>(endpoint, {\n          files,\n          input,\n          onUploadProgress: (progress) => {\n            if (!opts?.onUploadProgress) return;\n            fileProgress.current.set(progress.file, progress.progress);\n            let sum = 0;\n            fileProgress.current.forEach((p) => {\n              sum += p;\n            });\n            const averageProgress =\n              Math.floor(sum / fileProgress.current.size / 10) * 10;\n            if (averageProgress !== uploadProgress.current) {\n              opts?.onUploadProgress?.(averageProgress);\n              uploadProgress.current = averageProgress;\n            }\n          },\n          onUploadBegin({ file }) {\n            if (!opts?.onUploadBegin) return;\n\n            opts.onUploadBegin(file);\n          },\n          url: initOpts.url,\n          package: \"@uploadthing/react\",\n        });\n\n        opts?.onClientUploadComplete?.(res);\n        return res;\n      } catch (e) {\n        let error: UploadThingError<inferErrorShape<TRouter>>;\n        if (e instanceof UploadThingError) {\n          error = e as UploadThingError<inferErrorShape<TRouter>>;\n        } else {\n          error = INTERNAL_DO_NOT_USE__fatalClientError(e as Error);\n          console.error(\n            \"Something went wrong. Please contact UploadThing and provide the following cause:\",\n            error.cause instanceof Error ? error.cause.toString() : error.cause,\n          );\n        }\n        opts?.onUploadError?.(error);\n      } finally {\n        setUploading(false);\n        fileProgress.current = new Map();\n        uploadProgress.current = 0;\n      }\n    });\n\n    return {\n      startUpload,\n      isUploading,\n      permittedFileInfo,\n    } as const;\n  };\n\n  return useUploadThing;\n};\n\nexport const generateReactHelpers = <TRouter extends FileRouter>(\n  initOpts?: GenerateTypedHelpersOptions,\n) => {\n  const url = resolveMaybeUrlArg(initOpts?.url);\n\n  return {\n    useUploadThing: INTERNAL_uploadthingHookGen<TRouter>({ url }),\n    uploadFiles: <TEndpoint extends keyof TRouter>(\n      endpoint: TEndpoint,\n      opts: DistributiveOmit<\n        Parameters<typeof DANGEROUS__uploadFiles<TRouter, TEndpoint>>[1],\n        \"url\"\n      >,\n    ) =>\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      DANGEROUS__uploadFiles<TRouter, TEndpoint>(endpoint, {\n        ...opts,\n        url,\n        package: \"@uploadthing/react\",\n      } as any),\n  } as const;\n};\n","// Ripped from https://github.com/scottrippey/react-use-event-hook\nimport React from \"react\";\n\ntype AnyFunction = (...args: any[]) => any;\nconst noop = () => void 0;\n\n/**\n * Suppress the warning when using useLayoutEffect with SSR. (https://reactjs.org/link/uselayouteffect-ssr)\n * Make use of useInsertionEffect if available.\n */\nconst useInsertionEffect =\n  typeof window !== \"undefined\"\n    ? // useInsertionEffect is available in React 18+\n      React.useInsertionEffect || React.useLayoutEffect\n    : noop;\n\n/**\n * Similar to useCallback, with a few subtle differences:\n * - The returned function is a stable reference, and will always be the same between renders\n * - No dependency lists required\n * - Properties or state accessed within the callback will always be \"current\"\n */\nexport function useEvent<TCallback extends AnyFunction>(\n  callback: TCallback,\n): TCallback {\n  // Keep track of the latest callback:\n  const latestRef = React.useRef<TCallback>(\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n    useEvent_shouldNotBeInvokedBeforeMount as any,\n  );\n  useInsertionEffect(() => {\n    latestRef.current = callback;\n  }, [callback]);\n\n  // Create a stable callback that always calls the latest callback:\n  // using useRef instead of useCallback avoids creating and empty array on every render\n  const stableRef = React.useRef<TCallback>();\n  if (!stableRef.current) {\n    stableRef.current = function (this: any) {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-return, prefer-rest-params, @typescript-eslint/no-unsafe-argument\n      return latestRef.current.apply(this, arguments as any);\n    } as TCallback;\n  }\n\n  return stableRef.current;\n}\n\n/**\n * Render methods should be pure, especially when concurrency is used,\n * so we will throw this error if the callback is called while rendering.\n */\nfunction useEvent_shouldNotBeInvokedBeforeMount() {\n  throw new Error(\n    \"INVALID_USEEVENT_INVOCATION: the callback from useEvent cannot be invoked before the component has mounted.\",\n  );\n}\n","// Ripped from https://usehooks-ts.com/react-hook/use-fetch\nimport { useEffect, useReducer, useRef } from \"react\";\n\nimport { safeParseJSON } from \"@uploadthing/shared\";\n\ninterface State<T> {\n  data?: T;\n  error?: Error;\n}\n\ntype Cache<T> = Record<string, T>;\n\n// discriminated union type\ntype Action<T> =\n  | { type: \"loading\" }\n  | { type: \"fetched\"; payload: T }\n  | { type: \"error\"; payload: Error };\n\nfunction useFetch<T = unknown>(url?: string, options?: RequestInit): State<T> {\n  const cache = useRef<Cache<T>>({});\n\n  // Used to prevent state update if the component is unmounted\n  const cancelRequest = useRef<boolean>(false);\n\n  const initialState: State<T> = {\n    error: undefined,\n    data: undefined,\n  };\n\n  // Keep state logic separated\n  const fetchReducer = (state: State<T>, action: Action<T>): State<T> => {\n    switch (action.type) {\n      case \"loading\":\n        return { ...initialState };\n      case \"fetched\":\n        return { ...initialState, data: action.payload };\n      case \"error\":\n        return { ...initialState, error: action.payload };\n      default:\n        return state;\n    }\n  };\n\n  const [state, dispatch] = useReducer(fetchReducer, initialState);\n\n  useEffect(() => {\n    // Do nothing if the url is not given\n    if (!url) return;\n\n    cancelRequest.current = false;\n\n    const fetchData = async () => {\n      dispatch({ type: \"loading\" });\n\n      // If a cache exists for this url, return it\n      if (cache.current[url]) {\n        dispatch({ type: \"fetched\", payload: cache.current[url] });\n        return;\n      }\n\n      try {\n        const response = await fetch(url, options);\n        if (!response.ok) {\n          throw new Error(response.statusText);\n        }\n\n        const dataOrError = await safeParseJSON<T>(response);\n        if (dataOrError instanceof Error) {\n          throw dataOrError;\n        }\n\n        cache.current[url] = dataOrError;\n        if (cancelRequest.current) return;\n\n        dispatch({ type: \"fetched\", payload: dataOrError });\n      } catch (error) {\n        if (cancelRequest.current) return;\n\n        dispatch({ type: \"error\", payload: error as Error });\n      }\n    };\n\n    void fetchData();\n\n    // Use the cleanup function for avoiding a possibly...\n    // ...state update after the component was unmounted\n    return () => {\n      cancelRequest.current = true;\n    };\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [url]);\n\n  return state;\n}\n\nexport default useFetch;\n"],"mappings":"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","names":["useRef","state","useRef","_a"]}